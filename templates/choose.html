<!DOCTYPE html>
<html lang="{{ language }}">
<head>
    <meta charset="UTF-8">
    <title>{{ translations.title }}</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container fade-in">
        <h1>{{ translations.choose_action }}</h1>
        <button id="download-btn" class="btn">üì• {{ translations.download_button }}</button>
        <a href="/ask" class="btn">‚ùì {{ translations.ask_button }}</a>

        <div id="loading" style="margin-top: 20px; display: none;">
            <div class="spinner"></div>
            <div id="progress-text" style="margin-top: 10px;">{{ translations.downloading_message }}</div>
        </div>
    </div>

    <div id="language-toggle" class="language-toggle">
        üåç
    </div>

    <div id="language-menu" class="language-menu">
        <a href="?lang=ru">–†—É—Å—Å–∫–∏–π</a>
        <a href="?lang=en">English</a>
    </div>

    <script>
        // –õ–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ
        const downloadBtn = document.getElementById('download-btn');
        const loading = document.getElementById('loading');
        const progressText = document.getElementById('progress-text');

        async function checkProgress() {
            const response = await fetch('/progress');
            const data = await response.json();
            const downloaded = data.downloaded_bytes || 0;
            const total = data.total_bytes || 1;
            const percent = ((downloaded / total) * 100).toFixed(1);

            progressText.innerText = `‚è≥ {{ translations.downloading_message }} ${(downloaded/1e6).toFixed(2)}MB / ${(total/1e6).toFixed(2)}MB (${percent}%)`;

            if (percent >= 100) {
                window.location.href = "/watch";
            } else {
                setTimeout(checkProgress, 2000);
            }
        }

        downloadBtn.addEventListener('click', async () => {
            loading.style.display = 'block';
            downloadBtn.disabled = true;

            const response = await fetch('/download');
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                setTimeout(checkProgress, 2000);
            }
        });

        const languageToggle = document.getElementById('language-toggle');
        const languageMenu = document.getElementById('language-menu');

        languageToggle.addEventListener('click', () => {
            languageMenu.classList.toggle('show');
        });

        const urlParams = new URLSearchParams(window.location.search);
        const lang = urlParams.get('lang');
        const savedLanguage = localStorage.getItem('language');

        if (lang && lang !== savedLanguage) {
            localStorage.setItem('language', lang);
            location.href = window.location.pathname; 
        }

        if (savedLanguage && !lang) {
            window.location.search = `?lang=${savedLanguage}`;
        }
    </script>
</body>
</html>
